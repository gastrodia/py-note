{% extends "base.html" %}

{% block content %}
{{ super() }}
<h2 id="__comments">{{ lang.t("meta.comments") }}</h2>
<div id="giscus"></div>

<script>
  function setGiscusTheme(theme) {

    const iframe = document.querySelector('iframe.giscus-frame')
    iframe.contentWindow.postMessage({
      giscus: {
        setConfig: { theme: theme }
      }
    }, 'https://giscus.app')
  }

  function schemeToTheme(scheme) {
    return scheme === "default" ? "light" : "dark"
  }

  function initGiscus(theme) {
    const script = document.createElement("script")

    script.type = "text/javascript"
    script.src = "https://giscus.app/client.js"
    script.async = true
    script.crossOrigin = "anonymous"
    script.setAttribute("data-repo", "gastrodia/py-note")
    script.setAttribute("data-repo-id", "R_kgDOQqTh2w")
    script.setAttribute("data-category", "Announcements")
    script.setAttribute("data-category-id", "DIC_kwDOQqTh284C0Oms")
    script.setAttribute("data-mapping", "pathname")
    script.setAttribute("data-strict", "0")
    script.setAttribute("data-reactions-enabled", "1")
    script.setAttribute("data-emit-metadata", "0")
    script.setAttribute("data-input-position", "top")
    script.setAttribute("data-theme", theme)
    script.setAttribute("data-lang", "zh-CN")
    document.querySelector("#giscus").appendChild(script)
  }

  document.addEventListener('DOMContentLoaded', () => {
    document$.subscribe((payload) => {
      const themeDom = document.querySelector("[data-md-color-scheme]")
      const scheme = themeDom.getAttribute("data-md-color-scheme")
      console.log(scheme)
      initGiscus(schemeToTheme(scheme))
    });
    component$.subscribe((component) => {
      if (component && component.color && component.color.scheme) {
        setGiscusTheme(schemeToTheme(component.color.scheme))
      }
    })
  })
</script>
{% endblock %}

{% block scripts %}
{{ super() }}

<!-- Service Worker æ³¨å†Œè„šæœ¬ -->
<script>
    // æ³¨å†Œ Service Workerï¼ˆç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘ï¼‰
    (async function () {
      try {
        if (!('serviceWorker' in navigator)) {
          console.warn('[SW] å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
          return false;
        }
        // å…ˆæµ‹è¯• sw.js æ˜¯å¦å¯è®¿é—®
        const swPath = '/sw.js';
        try {
          const testResponse = await fetch(swPath, { method: 'HEAD' });
          if (!testResponse.ok) {
            console.error('[SW] âœ— æ— æ³•è®¿é—® sw.js æ–‡ä»¶ï¼ŒHTTP çŠ¶æ€:', testResponse.status);
            return false;
          }
        } catch (fetchError) {
          console.error('[SW] âœ— æ— æ³•è®¿é—® sw.js æ–‡ä»¶:', fetchError.message);
          return false;
        }

        console.log('[SW] â³ æ­£åœ¨æ³¨å†Œ Service Worker...');
        const registration = await navigator.serviceWorker.register(swPath, {
          scope: '/'
        });

        console.log('[SW] âœ“ Service Worker æ³¨å†ŒæˆåŠŸï¼Œä½œç”¨åŸŸ:', registration.scope);

        // ç­‰å¾… Service Worker æ¿€æ´»
        await navigator.serviceWorker.ready;
        console.log('[SW] âœ“ Service Worker å·²å°±ç»ª');

        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ controllerï¼ˆé¡µé¢æ˜¯å¦è¢« Service Worker æ¥ç®¡ï¼‰
        if (navigator.serviceWorker.controller) {
          console.log('[SW] âœ“ Service Worker å·²æ¥ç®¡é¡µé¢ï¼ŒCDN èµ„æºå°†ä»ç¼“å­˜åŠ è½½');
        } else {
          console.log('[SW] â„¹ Service Worker å·²æ³¨å†Œä½†æœªæ¥ç®¡å½“å‰é¡µé¢');
          console.log('[SW] ğŸ’¡ åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰åå°†å¯ç”¨ç¼“å­˜åŠ é€Ÿ');
        }

        return true;
      } catch (error) {
        console.error('[SW] âœ— Service Worker æ³¨å†Œå¤±è´¥:', error);
        return false;
      }
    })();

  // å…¨å±€è°ƒè¯•å·¥å…·ï¼ˆå¯åœ¨æ§åˆ¶å°ä½¿ç”¨ï¼‰
  window.swDebug = {
    // æ¸…ç†ç¼“å­˜: swDebug.clearCache()
    async clearCache() {
      if (!('serviceWorker' in navigator)) {
        console.warn('[Debug] å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
        return false;
      }
      try {
        const registration = await navigator.ready;
        const messageChannel = new MessageChannel();
        return new Promise((resolve) => {
          messageChannel.port1.onmessage = (event) => {
            if (event.data.success) {
              console.log('[Debug] âœ“ ç¼“å­˜å·²æ¸…ç†');
              resolve(true);
            }
          };
          registration.active.postMessage(
            { type: 'CLEAR_CACHE' },
            [messageChannel.port2]
          );
        });
      } catch (error) {
        console.error('[Debug] æ¸…ç†ç¼“å­˜å¤±è´¥:', error);
        return false;
      }
    },

    // æŸ¥çœ‹ç¼“å­˜çŠ¶æ€: swDebug.getCacheInfo()
    async getCacheInfo() {
      if (!('caches' in window)) {
        console.warn('[Debug] å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Cache API');
        return null;
      }
      try {
        const cache = await caches.open('cache-v1');
        const keys = await cache.keys();

        console.log('=== ç¼“å­˜çŠ¶æ€ ===');
        console.log(`å…±ç¼“å­˜ ${keys.length} ä¸ªæ–‡ä»¶ï¼š`);

        let totalSize = 0;
        let opaqueCount = 0;
        for (const request of keys) {
          const response = await cache.match(request);
          if (response) {
            const blob = await response.blob();
            const size = blob.size;
            totalSize += size;

            let sizeStr;
            if (size === 0) {
              sizeStr = `å·²ç¼“å­˜ âœ“ (opaque)`;
              opaqueCount++;
            } else if (size < 1024) {
              sizeStr = `${size} å­—èŠ‚`;
            } else if (size < 1024 * 1024) {
              sizeStr = `${(size / 1024).toFixed(2)} KB`;
            } else {
              sizeStr = `${(size / 1024 / 1024).toFixed(2)} MB`;
            }

            console.log(`  âœ“ ${request.url.split('/').pop()} (${sizeStr})`);
          }
        }

        console.log(`æ€»å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)} MB${opaqueCount > 0 ? ` (ä¸å« ${opaqueCount} ä¸ª opaque æ–‡ä»¶)` : ''}`);
        console.log('================');

        return { count: keys.length, totalSize: totalSize };
      } catch (error) {
        console.error('[Debug] è·å–ç¼“å­˜ä¿¡æ¯å¤±è´¥:', error);
        return null;
      }
    }
  };

</script>

<!-- ä»£ç è¿è¡Œå™¨ -->
<script src="{{ 'assets/js/code-runner.js' | url }}"></script>
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ 'assets/css/code-runner.css' | url }}">
{% endblock %}